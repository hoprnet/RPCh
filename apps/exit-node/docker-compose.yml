# docker-compose file that allows RPCh exit node to run alongside HOPRd
version: "3"

volumes:
  hoprd-data:
  exit-node-data:

services:
  hoprd:
    image: gcr.io/hoprassociation/hoprd:1.92.9@sha256:e23973ad8c5c6551f822e4aaafb6a9ff39d62fcbe153eb6946af078a63d11681
    restart: unless-stopped
    ports:
      - "3000:3000"
      - "3001:3001"
      - "9091:9091"
      - "8080:8080"
    volumes:
      - hoprd-data:/tmp
    environment:
      - HOPRD_HOST=0.0.0.0:9091
      - HOPRD_API_HOST=0.0.0.0
      - HOPRD_ADMIN_HOST=0.0.0.0
      - HOPRD_ADMIN=true
      - HOPRD_API=true
      - HOPRD_INIT=true
      - HOPRD_ENVIRONMENT=${HOPRD_ENVIRONMENT}
      - HOPRD_API_TOKEN=${HOPRD_API_TOKEN}
      - HOPRD_PASSWORD=${HOPRD_PASSWORD}
      - HOPRD_ANNOUNCE=true
  exit-node:
    build:
      dockerfile: apps/exit-node/Dockerfile
      context: ../../
    depends_on:
      - hoprd
    restart: unless-stopped
    volumes:
      - exit-node-data:/tmp
    environment:
      - HOPRD_API_ENDPOINT=http://hoprd:3001
      - DEBUG=${DEBUG}
      - HOPRD_API_TOKEN=${HOPRD_API_TOKEN}
      - RPCH_PASSWORD=${RPCH_PASSWORD}
      - RPCH_IDENTITY_DIR=${RPCH_IDENTITY_DIR}
      - RPCH_PRIVATE_KEY=${RPCH_PRIVATE_KEY}
      - RPCH_DATA_DIR=${RPCH_DATA_DIR}
    entrypoint:
      [
        "/bin/wait-for",
        "http://${HOPRD_API_TOKEN}@hoprd:3001/api/v2/account/addresses",
        "-t",
        "300",
        "--",
        "/sbin/tini",
        "--",
      ]
    command: "node apps/exit-node/build/index.js"
